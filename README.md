# 👟Sneakers Commerce API

## 🔍 Overview

이 프로젝트는 **스니커즈 이커머스 플랫폼**을 구축하기 위한 백엔드 서버입니다. 사용자는 원하는 스니커즈 상품을 탐색하고, 미리 충전된 잔액으로 빠르게 주문 및 결제를 진행할 수 있습니다. 
**관리자(Admin)**, **판매자(Seller)**, **사용자(Buyer)** 총 세 가지 역할이 존재하며, 단일 `User` 테이블 내 `Dtype`을 통해 역할을 구분하는 **싱글 테이블 상속 전략**을 사용했습니다.

> 핵심 목표: Teatable, OOP, 동시성과 분산 환경을 고려한 이커머스 시스템 구현
>

---

## 핵심 아키텍처 개요

### 도메인 역할 분리

- **User(Dtype: ADMIN, SELLER, BUYER)**
    - 모든 사용자는 하나의 테이블에 저장되며, 역할에 따라 기능과 권한이 다릅니다.
    - 판매자(Seller)는 **쿠폰 발급권한**을 갖습니다.
- **Coupon 도메인**
    - 판매자 전용 쿠폰 발급 정책이 존재합니다.
    - 쿠폰은 `정률(%)` 및 `정액(₩)` 할인으로 구분되며, 수량 제한 및 유효기간을 가집니다.
    - 선착순 쿠폰 발급 시 `Redis` 기반 동시성 제어를 수행합니다.

### 주문 및 결제 흐름

- 주문 생성 시 상품 재고 및 쿠폰 유효성을 확인하며, 결제는 충전된 잔액 기반으로 진행됩니다.
- 결제 성공 시 `잔액 차감`, `결제 정보 저장`, `외부 플랫폼 전송 이벤트 발행`이 **트랜잭션 내에서 원자적**으로 처리됩니다.
- 외부 전송은 **트랜잭셔널 아웃박스 패턴** 기반으로 **ORDER_EVENTS 테이블**에 저장된 이벤트를 주기적으로 비동기 처리합니다.

### 트랜잭셔널 아웃박스 패턴 적용

- 도메인 이벤트(OrderCreated, PaymentCompleted 등)는 `OutboxService`를 통해 이벤트 테이블에 저장됩니다.
- `EventRelayScheduler`가 주기적으로 미처리 이벤트를 외부 플랫폼으로 전송합니다.
- 이 구조를 통해 **DB 트랜잭션과 외부 호출 간의 결합도**를 낮추고, 장애 내성을 확보합니다.

---

## 📌 기능 요약 및 API

| 기능 | 설명 |
| --- | --- |
| 잔액 충전/조회 | 사용자 잔액을 충전하거나 조회합니다. |
| 상품 조회 | 전체 상품 목록 또는 상세 조회를 지원합니다. |
| 주문 생성 | 재고 확인 후 주문을 생성합니다. |
| 결제 처리 | 주문 결제 및 잔액 차감, 외부 이벤트 전송을 처리합니다. |
| 쿠폰 발급/사용 | 판매자가 발급한 쿠폰을 사용자가 발급받고 사용할 수 있습니다. |
| 인기 상품 조회 | 최근 3일간 가장 많이 팔린 상품 Top 5를 제공합니다. |

---

```bash
src
├── api               # Swagger 명세 전용 인터페이스
├── domain
│   ├── order         # 주문 도메인
│   ├── payment       # 결제 도메인
│   ├── product       # 상품 도메인
│   ├── coupon        # 쿠폰 도메인
│   ├── user          # 사용자 및 잔액 도메인
├── common            # 공통 응답, 예외 처리, 유틸
├── config            # 설정 관련 (Redis, Swagger 등)
├── external          # 외부 플랫폼 연동 모듈
└── test              # 단위 테스트 및 통합 테스트
```

---

## 설계 다이어그램

- [시퀀스 다이어그램](./docs/sequence-diagram) : 잔액 충전, 주문/결제, 상품 조회, 쿠폰 발급 등 주요 비즈니스 흐름
- [클래스 다이어그램](./docs/class-diagram) : 도메인 모델 및 관계, 도메인 중심 설계, 서비스 책임 분리, 이벤트 흐름 표현
- [상태 다이어그램](./docs/state-diagram) : 주문 / 결제 / 쿠폰 상태 전이 및 상태 흐름 정의
- [ERD](./docs/er-diagram) : User, Order, Product, Coupon, Payment, Event 테이블 구조 및 관계
- [Event Storming](./docs/event-storming) : 도메인 이벤트 기반 비즈니스 플로우 분석 및 프로세스 모델링

---