# 👟 Sneakers Commerce API

## 🔍 Overview

이 프로젝트는 **스니커즈 이커머스 플랫폼**을 구축하기 위한 백엔드 시스템입니다.

사용자는 스니커즈 상품을 탐색하고, **사전에 충전된 잔액**으로 빠르게 **주문 및 결제**를 진행할 수 있습니다.

또한, **관리자(Admin)**, **판매자(Seller)**, **사용자(Buyer)** 세 가지 역할이 존재하며,

하나의 `User` 테이블에 `Dtype` 필드를 사용한 **싱글 테이블 상속 전략(STI)**으로 역할을 구분합니다.

> 핵심 목표: Testable, OOP, 동시성과 분산 환경을 고려한 설계
>

---

## 핵심 아키텍처 개요

### ✅ 도메인 역할 분리

- **User (Dtype: ADMIN, SELLER, BUYER)**
  - 단일 테이블에 저장되며, 역할에 따라 기능/권한 분리
  - *판매자(Seller)**는 **쿠폰 발급 권한** 보유
- **Coupon 도메인**
  - 판매자 전용 발급 정책 존재 (정률/정액 할인, 유효기간, 수량 제한)
  - **선착순 쿠폰 발급 시 Redis 기반 동시성 제어 적용**

---

### ✅ 주문 및 결제 흐름

- 주문 생성 시: **상품 재고** 및 **쿠폰 유효성** 확인
- 결제 진행 시: 충전된 잔액 기반, 성공 시
  - `잔액 차감`
  - `결제 정보 저장`
  - `주문 상태 CONFIRMED로 변경`
  - `외부 전송 이벤트 발행`

    → 모두 **트랜잭션 내에서 원자적으로 처리**

- 외부 전송은 **트랜잭셔널 아웃박스 패턴**을 적용하여

  **ORDER_EVENTS 테이블(PENDING)** → 비동기 전송


---

### ✅ 트랜잭셔널 아웃박스 패턴 적용

- 도메인 이벤트(OrderCreated, PaymentCompleted 등)는 `OutboxService`를 통해 저장
- `EventRelayScheduler`가 주기적으로 미전송 이벤트를 외부 플랫폼으로 전송
- 외부 전송 실패 시 `RETRY`, `ALERT` 등으로 상태 전이
- 이를 통해 **DB 트랜잭션 일관성과 외부 연동 실패 복원력 확보**

---

## 📌 기능 요약 및 주요 API

| 기능 | 설명 |
| --- | --- |
| 잔액 충전/조회 | 사용자 잔액을 충전하거나 조회 |
| 상품 조회 | 전체 상품 목록 또는 상세 정보 조회 |
| 주문 생성 | 재고 및 쿠폰 검증 후 주문 생성 |
| 결제 처리 | 잔액 차감 → 결제 승인 → 이벤트 전송 |
| 쿠폰 발급/사용 | 판매자 발급, 사용자 발급/적용 |
| 인기 상품 조회 | 최근 3일간 판매량 기준 Top 5 제공 |


